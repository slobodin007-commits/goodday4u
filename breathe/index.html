<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Breathe ‚Äî goodday4u.com</title>
    <script src="../js/translations.js"></script>
    <script src="../js/common.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #ffffff;
            color: #333;
            min-height: 100vh;
            overflow: hidden;
        }

        .main-wrapper {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            gap: 2rem;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem 1rem;
        }

        .ad-sidebar {
            width: 160px;
            min-width: 160px;
            position: sticky;
            top: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .ad-block {
            width: 160px;
            min-height: 600px;
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 0.85rem;
            text-align: center;
            padding: 1rem;
        }

        .ad-block::before {
            content: 'Ad';
            font-size: 0.75rem;
            color: #ccc;
        }

        .container {
            flex: 1;
            text-align: center;
            max-width: 400px;
            margin: 0 auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(135deg, #a8e6cf 0%, #88d8a3 100%);
            margin: 2rem auto;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.3s ease;
            box-shadow: 0 4px 20px rgba(136, 216, 163, 0.3);
        }

        .circle:active {
            transform: scale(0.98);
        }

        .circle-text {
            color: #ffffff;
            font-size: 1.2rem;
            font-weight: 300;
            user-select: none;
        }

        .hint {
            color: #999;
            font-size: 0.9rem;
            margin-top: 1rem;
            font-weight: 300;
            line-height: 1.6;
        }
        
        .instruction {
            color: #666;
            font-size: 1rem;
            margin-bottom: 1.5rem;
            font-weight: 400;
            line-height: 1.5;
        }

        .sound-toggle {
            color: #999;
            font-size: 0.85rem;
            padding: 0.5rem 1rem;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #ffffff;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            margin-top: 1rem;
        }

        .sound-toggle:hover {
            color: #666;
            border-color: #ccc;
        }

        .sound-toggle.active {
            color: #88d8a3;
            border-color: #88d8a3;
        }

        .back-link {
            position: absolute;
            top: 1rem;
            left: 1rem;
            color: #999;
            text-decoration: none;
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .back-link:hover {
            color: #666;
            border-color: #ccc;
        }

        .top-bar {
            display: none;
        }

        .bottom-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 2rem;
            flex-wrap: wrap;
            gap: 0.75rem;
            padding-top: 2rem;
            border-top: 1px solid #e0e0e0;
        }

        .top-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #ffffff;
            color: #666;
            text-decoration: none;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .top-btn:hover {
            color: #333;
            border-color: #ccc;
        }

        .lang-selector {
            position: relative;
        }

        .lang-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #ffffff;
            color: #666;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .lang-btn:hover {
            color: #333;
            border-color: #ccc;
        }

        .lang-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: none;
            flex-direction: column;
            min-width: 150px;
            z-index: 1000;
        }

        .lang-menu.show {
            display: flex;
        }

        .lang-option {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background 0.2s ease;
            border: none;
            background: none;
            text-align: left;
            font-size: 0.9rem;
            color: #333;
        }

        .lang-option:hover {
            background: #f9f9f9;
        }

        .lang-option.active {
            background: #f0f0f0;
            font-weight: 500;
        }

        @keyframes pulse-in {
            0% {
                transform: scale(1);
            }
            100% {
                transform: scale(1.3);
            }
        }

        @keyframes pulse-out {
            0% {
                transform: scale(1.3);
            }
            100% {
                transform: scale(1);
            }
        }

        .breathing-in {
            animation: pulse-in 4s ease-in-out;
        }

        .breathing-out {
            animation: pulse-out 4s ease-in-out;
        }
    </style>
</head>
<body>
    <div class="main-wrapper">
        <div class="ad-sidebar ad-left">
            <div class="ad-block" id="adLeft">
                <!-- Ad space - 160x600 -->
            </div>
        </div>

        <div class="container">
            <a href="../index.html" class="back-link" data-translate="back">‚Üê Back</a>
        <p class="instruction" data-translate-html="breatheInstruction">–•–æ—á–µ—à—å —É—Å–ø–æ–∫–æ–∏—Ç—å—Å—è?<br>–ù–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –∏ –¥—ã—à–∏</p>
        <div class="circle" id="circle">
            <div class="circle-text" id="circleText" data-translate="breatheStart">Click to start</div>
        </div>
        <p class="hint" data-translate="breatheHint">–°–ª–µ–¥—É–π —Ä–∏—Ç–º—É –ø—É–ª—å—Å–∞—Ü–∏–∏</p>
        <div class="sound-toggle" id="soundToggle" data-translate="soundOn">üîä Sound</div>
        
        <div class="bottom-bar">
            <button class="top-btn" onclick="openDonate()" data-translate="donate">Support</button>
            <div class="lang-selector">
                <button class="lang-btn" id="langBtn" data-translate="language">Language</button>
                <div class="lang-menu" id="langMenu">
                    <button class="lang-option" data-lang="en">English</button>
                    <button class="lang-option" data-lang="ru">–†—É—Å—Å–∫–∏–π</button>
                    <button class="lang-option" data-lang="he">◊¢◊ë◊®◊ô◊™</button>
                    <button class="lang-option" data-lang="de">Deutsch</button>
                    <button class="lang-option" data-lang="cs">ƒåe≈°tina</button>
                </div>
            </div>
            <button class="top-btn" onclick="shareSite()" data-translate="share">Share</button>
        </div>
        </div>

        <div class="ad-sidebar ad-right">
            <div class="ad-block" id="adRight">
                <!-- Ad space - 160x600 -->
            </div>
        </div>
    </div>

        <div class="ad-sidebar ad-right">
            <div class="ad-block" id="adRight">
                <!-- Ad space - 160x600 -->
            </div>
        </div>
    </div>

    <script>
        const circle = document.getElementById('circle');
        const circleText = document.getElementById('circleText');
        const soundToggle = document.getElementById('soundToggle');
        let isBreathing = false;
        let rainSound = null;
        let hasInteracted = false;
        let soundEnabled = true;

        // Language selector
        const langBtn = document.getElementById('langBtn');
        const langMenu = document.getElementById('langMenu');
        const langOptions = langMenu.querySelectorAll('.lang-option');

        langBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            langMenu.classList.toggle('show');
        });

        document.addEventListener('click', (e) => {
            if (!langMenu.contains(e.target) && e.target !== langBtn) {
                langMenu.classList.remove('show');
            }
        });

        langOptions.forEach(option => {
            option.addEventListener('click', () => {
                const lang = option.getAttribute('data-lang');
                setLanguage(lang);
                langMenu.classList.remove('show');
                
                langOptions.forEach(opt => opt.classList.remove('active'));
                option.classList.add('active');
                
                updateTexts();
            });
        });

        function updateTexts() {
            const t = translations[currentLang] || translations['en'];
            if (isBreathing) {
                if (circle.classList.contains('breathing-in')) {
                    circleText.textContent = t.breatheIn;
                } else if (circle.classList.contains('breathing-out')) {
                    circleText.textContent = t.breatheOut;
                }
            } else {
                circleText.textContent = t.breatheStart;
            }
            soundToggle.textContent = soundEnabled ? t.soundOn : t.soundOff;
        }

        window.addEventListener('languagechange', () => {
            updateTexts();
        });

        // Set active language on load
        window.addEventListener('DOMContentLoaded', () => {
            const currentLang = localStorage.getItem('language') || 'en';
            langOptions.forEach(opt => {
                if (opt.getAttribute('data-lang') === currentLang) {
                    opt.classList.add('active');
                }
            });
            updateTexts();
        });

        function loadRainSound() {
            if (rainSound) return;
            rainSound = new Audio("./rain.mp3");
            rainSound.preload = "auto";
            rainSound.volume = 0.4;
            rainSound.loop = true;
            rainSound.addEventListener('error', (e) => {
                console.error("Error loading rain sound:", e);
            });
            rainSound.addEventListener('canplaythrough', () => {
                console.log("Rain sound loaded successfully");
            });
        }

        let breathingInterval = null;

        function startBreathing() {
            if (!hasInteracted) {
                hasInteracted = true;
                loadRainSound();
            }

            if (isBreathing) return;
            
            console.log('[BREATHE] Starting breathing animation');
            isBreathing = true;
            circle.classList.add('breathing-in');
            const t = translations[currentLang] || translations['en'];
            circleText.textContent = t.breatheIn;
            
            const startTime = Date.now();
            console.log('[BREATHE] Start time:', startTime, 'Phase: IN');
            
            if (rainSound && soundEnabled) {
                rainSound.currentTime = 0;
                rainSound.play().catch(e => {
                    console.error("Error playing rain sound:", e);
                });
            }

            let phase = 'in';
            let cycleCount = 0;
            let animationEndHandler = null;
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
            animationEndHandler = (e) => {
                if (!isBreathing) return;
                
                cycleCount++;
                const cycleTime = Date.now();
                const elapsed = cycleTime - startTime;
                
                console.log(`[BREATHE] Animation ended: ${e.animationName}, Phase: ${phase}, Cycle #${cycleCount} at ${elapsed}ms`);
                
                // –ü–æ–ª—É—á–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–∏
                const finalTransform = window.getComputedStyle(circle).transform;
                console.log(`[BREATHE] Final transform after animation: ${finalTransform}`);
                
                // –ñ–¥–µ–º –æ–¥–∏–Ω –∫–∞–¥—Ä –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º
                requestAnimationFrame(() => {
                    if (!isBreathing) return;
                    
                        const t = translations[currentLang] || translations['en'];
                        if (phase === 'in') {
                            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤—ã–¥–æ—Ö - –Ω–∞—á–∏–Ω–∞–µ–º —Å scale(1.3) (—Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–¥–æ—Ö–∞)
                            circle.style.transform = 'scale(1.3)';
                            circle.classList.remove('breathing-in');
                            circle.classList.add('breathing-out');
                            circleText.textContent = t.breatheOut;
                            phase = 'out';
                            console.log(`[BREATHE] Switched to OUT - Set transform to scale(1.3)`);
                        } else {
                            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–¥–æ—Ö - –Ω–∞—á–∏–Ω–∞–µ–º —Å scale(1) (—Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—ã–¥–æ—Ö–∞)
                            circle.style.transform = 'scale(1)';
                            circle.classList.remove('breathing-out');
                            circle.classList.add('breathing-in');
                            circleText.textContent = t.breatheIn;
                            phase = 'in';
                            console.log(`[BREATHE] Switched to IN - Set transform to scale(1)`);
                        }
                    
                    const afterTransform = window.getComputedStyle(circle).transform;
                    console.log(`[BREATHE] After switch, Transform: ${afterTransform}`);
                    console.log('---');
                });
            };
            
            circle.addEventListener('animationend', animationEndHandler);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
            startBreathing.animationEndHandler = animationEndHandler;

            // –ê–Ω–∏–º–∞—Ü–∏—è —Ç–µ–ø–µ—Ä—å –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏–µ animationend
            // –ù–µ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–∞–π–º–µ—Ä—ã - –∞–Ω–∏–º–∞—Ü–∏—è —Å–∞–º–∞ —Å–æ–æ–±—â–∏—Ç –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
            console.log('[BREATHE] Animation will switch automatically on animationend event');
        }

        function stopBreathing() {
            console.log('[BREATHE] Stopping breathing animation');
            isBreathing = false;
            
            // –û—á–∏—â–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª (–µ—Å–ª–∏ –±—ã–ª)
            if (breathingInterval) {
                clearInterval(breathingInterval);
                breathingInterval = null;
                console.log('[BREATHE] Interval cleared');
            }
            
            // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ animationend
            if (startBreathing.animationEndHandler) {
                circle.removeEventListener('animationend', startBreathing.animationEndHandler);
                console.log('[BREATHE] Animation end handler removed');
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
            circle.classList.remove('breathing-in', 'breathing-out');
            circle.style.animation = 'none';
            circle.style.transform = 'scale(1)';
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º transform
            setTimeout(() => {
                circle.style.animation = '';
                console.log('[BREATHE] Animation reset complete');
            }, 10);
            
            const t = translations[currentLang] || translations['en'];
            circleText.textContent = t.breatheStart;
            
            if (rainSound) {
                rainSound.pause();
                rainSound.currentTime = 0;
            }
        }

        soundToggle.addEventListener('click', () => {
            soundEnabled = !soundEnabled;
            soundToggle.classList.toggle('active', soundEnabled);
            const t = translations[currentLang] || translations['en'];
            soundToggle.textContent = soundEnabled ? t.soundOn : t.soundOff;
            
            if (rainSound && isBreathing) {
                if (soundEnabled) {
                    rainSound.play().catch(e => {
                        console.error("Error playing rain sound:", e);
                    });
                } else {
                    rainSound.pause();
                }
            }
        });

        circle.addEventListener('click', () => {
            if (isBreathing) {
                stopBreathing();
            } else {
                startBreathing();
            }
        });

        // Touch support
        circle.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (isBreathing) {
                stopBreathing();
            } else {
                startBreathing();
            }
        });
    </script>
</body>
</html>

